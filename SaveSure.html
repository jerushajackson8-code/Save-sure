<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>SaveSure ğŸŒ±</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Nunito',sans-serif;background:#f0fdf4;color:#064e3b}
:root{--g1:#047857;--g2:#059669;--g3:#10b981;--g4:#d1fae5;--g5:#f0fdf4;
  --dk:#064e3b;--md:#065f46;--sf:#6ee7b7;
  --rd:#ef4444;--am:#f59e0b;--bl:#3b82f6}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:var(--g3);border-radius:3px}
#root{max-width:480px;margin:0 auto;min-height:100vh;background:#fff;
  box-shadow:0 0 40px rgba(5,150,105,.1)}

/* WELCOME */
.welcome{min-height:100vh;background:linear-gradient(150deg,#047857,#059669 50%,#10b981);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:40px 24px;color:#fff;text-align:center}
.wlogo{font-size:80px;animation:bob 3s ease-in-out infinite}
@keyframes bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-16px)}}
.wtitle{font-size:40px;font-weight:900;margin:14px 0 10px;letter-spacing:-1.5px}
.wsub{font-size:17px;opacity:.9;margin-bottom:32px;line-height:1.6}
.wfeats{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:36px;width:100%;max-width:340px}
.wfeat{background:rgba(255,255,255,.13);border-radius:14px;padding:14px 10px;
  font-size:13px;font-weight:700;backdrop-filter:blur(8px)}
.wfeat span{display:block;font-size:26px;margin-bottom:6px}
.wbtn{background:#fff;color:var(--g2);border:none;padding:16px 52px;border-radius:16px;
  font-size:18px;font-weight:900;cursor:pointer;transition:all .2s;font-family:'Nunito',sans-serif}
.wbtn:hover{transform:translateY(-3px);box-shadow:0 10px 28px rgba(0,0,0,.18)}

/* REGISTER */
.regwrap{min-height:100vh;background:var(--g5);padding:32px 20px 40px}
.reghead{text-align:center;margin-bottom:26px}
.reghead h2{font-size:26px;font-weight:900;color:var(--dk)}
.reghead p{color:var(--g2);font-size:13px;margin-top:6px}

/* HEADER */
.hdr{background:linear-gradient(135deg,var(--g2),var(--g3));color:#fff;
  padding:16px 18px;display:flex;justify-content:space-between;align-items:center;
  position:sticky;top:0;z-index:50;box-shadow:0 2px 12px rgba(5,150,105,.2)}
.hdr h1{font-size:21px;font-weight:900;letter-spacing:-.5px}
.hdr .hsub{font-size:12px;opacity:.85;margin-top:2px}
.hicns{display:flex;gap:8px}
.hic{background:rgba(255,255,255,.18);border:none;width:38px;height:38px;border-radius:50%;
  font-size:17px;cursor:pointer;transition:all .2s;color:#fff;display:grid;place-items:center}
.hic:hover{background:rgba(255,255,255,.3);transform:scale(1.08)}

/* BALANCE */
.balcard{background:linear-gradient(135deg,#047857,#10b981);color:#fff;
  margin:14px;border-radius:22px;padding:22px 20px;
  box-shadow:0 10px 30px rgba(5,150,105,.25)}
.balamt{font-size:44px;font-weight:900;margin:8px 0 16px;letter-spacing:-2px}
.balrow{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.balst{background:rgba(255,255,255,.15);border-radius:12px;padding:10px 8px;text-align:center}
.balst .v{font-size:17px;font-weight:800;margin-top:4px}
.balst .l{font-size:10px;text-transform:uppercase;letter-spacing:.8px;opacity:.85}

/* QUICK ACTIONS */
.qarow{display:grid;grid-template-columns:1fr 1fr;gap:11px;padding:0 14px 14px}
.qabtn{border:none;border-radius:18px;padding:18px 14px;cursor:pointer;
  display:flex;flex-direction:column;align-items:center;gap:7px;
  font-family:'Nunito',sans-serif;transition:all .2s}
.qabtn:hover{transform:translateY(-3px)}
.qabtn .qi{font-size:30px}
.qabtn .ql{font-size:13px;font-weight:800;color:var(--dk)}
.qainc{background:linear-gradient(135deg,#d1fae5,#a7f3d0);border:2px solid #10b981}
.qaexp{background:linear-gradient(135deg,#fee2e2,#fecaca);border:2px solid var(--rd)}
.qasav{background:linear-gradient(135deg,#fef3c7,#fde68a);border:2px solid var(--am)}
.qanew{background:linear-gradient(135deg,#dbeafe,#bfdbfe);border:2px solid var(--bl)}

/* PAGE */
.page{padding:14px;display:none}
.page.show{display:block;animation:fu .22s ease-out}
@keyframes fu{from{opacity:0;transform:translateY(7px)}to{opacity:1;transform:translateY(0)}}
.stitle{font-size:19px;font-weight:900;color:var(--dk);margin-bottom:12px}

/* CARD */
.card{background:#fff;border-radius:18px;padding:16px;margin-bottom:12px;
  border:1.5px solid var(--g4);box-shadow:0 2px 10px rgba(5,150,105,.07)}

/* PIGGY */
.piggrid{display:grid;grid-template-columns:1fr 1fr;gap:11px;margin-bottom:16px}
.pigcard{background:linear-gradient(135deg,#fffbeb,#fef3c7);border:2px solid #fbbf24;
  border-radius:18px;padding:14px;text-align:center;cursor:pointer;
  transition:all .25s;position:relative;overflow:hidden}
.pigcard:hover{transform:translateY(-4px);box-shadow:0 8px 22px rgba(251,191,36,.28)}
.pig-ico{font-size:38px;margin-bottom:6px}
.pig-nm{font-size:12px;font-weight:800;color:#92400e;margin-bottom:4px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pig-am{font-size:14px;font-weight:900;color:#78350f}
.pig-pc{font-size:10px;color:#92400e;margin-top:2px}
.pig-bar{background:rgba(120,53,15,.15);height:4px;border-radius:2px;margin-top:8px;overflow:hidden}
.pig-fill{background:#b45309;height:100%;border-radius:2px;transition:width .5s}
.pig-x{position:absolute;top:7px;right:7px;background:rgba(239,68,68,.18);
  color:var(--rd);border:none;width:20px;height:20px;border-radius:50%;
  font-size:11px;cursor:pointer;font-weight:900;display:grid;place-items:center}

/* TRANSACTIONS */
.txitem{display:flex;align-items:center;gap:11px;padding:11px 0;
  border-bottom:1.5px solid var(--g5)}
.txitem:last-child{border-bottom:none}
.txic{width:44px;height:44px;border-radius:12px;display:grid;place-items:center;font-size:20px;flex-shrink:0}
.txic.income{background:#d1fae5}.txic.expense{background:#fee2e2}
.txic.savings{background:#fef3c7}.txic.transfer{background:#dbeafe}
.txbd{flex:1;min-width:0}
.txcat{font-size:13px;font-weight:800;color:var(--dk);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.txdsc{font-size:11px;color:var(--g2);margin-top:1px}
.txdt{font-size:10px;color:var(--sf);margin-top:2px}
.txrt{display:flex;flex-direction:column;align-items:flex-end;gap:5px;flex-shrink:0}
.txam{font-size:15px;font-weight:900}
.txam.income{color:#059669}.txam.expense{color:var(--rd)}.txam.savings{color:var(--am)}
.delbtn{background:#fee2e2;color:var(--rd);border:none;padding:4px 10px;
  border-radius:7px;font-size:11px;font-weight:800;cursor:pointer;font-family:'Nunito',sans-serif}
.delbtn:hover{background:#fecaca}

/* FORMS */
.fg{margin-bottom:16px}
label{display:block;font-size:13px;font-weight:800;color:var(--md);margin-bottom:6px}
.inp,.sel{width:100%;padding:13px 14px;border:2px solid var(--g4);border-radius:13px;
  font-size:15px;font-family:'Nunito',sans-serif;color:var(--dk);background:#fff;transition:border .2s}
.inp:focus,.sel:focus{outline:none;border-color:var(--g3);box-shadow:0 0 0 3px rgba(16,185,129,.1)}
.sel{appearance:none;
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23065f46' d='M6 9L1 4h10z'/%3E%3C/svg%3E")
  no-repeat right 12px center #fff}
.btn{width:100%;padding:14px;border:none;border-radius:13px;font-size:15px;font-weight:900;
  cursor:pointer;font-family:'Nunito',sans-serif;transition:all .2s;letter-spacing:-.2px}
.btn:hover{transform:translateY(-2px)}
.btn-g{background:linear-gradient(135deg,var(--g2),var(--g3));color:#fff}
.btn-s{background:var(--g4);color:var(--dk);margin-top:9px}
.btn-r{background:#fee2e2;color:var(--rd);margin-top:9px}
.btsm{width:auto;padding:8px 16px;font-size:12px;font-weight:800;border:none;border-radius:9px;
  cursor:pointer;font-family:'Nunito',sans-serif;transition:all .2s}
.btsm:hover{transform:translateY(-1px)}
.btsm-g{background:linear-gradient(135deg,var(--g2),var(--g3));color:#fff}
.btsm-s{background:var(--g4);color:var(--dk)}
.btsm-r{background:#fee2e2;color:var(--rd)}

/* BOTTOM NAV */
.bnav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;
  background:#fff;border-top:2px solid var(--g4);display:flex;padding:8px 0 10px;z-index:60;
  box-shadow:0 -3px 14px rgba(5,150,105,.07)}
.nit{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;
  cursor:pointer;color:var(--sf);transition:all .2s;padding:3px}
.nit.on{color:var(--g3)}.nit .ni{font-size:21px}.nit .nl{font-size:10px;font-weight:800}

/* MODAL */
.ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.46);z-index:200;
  align-items:flex-end;justify-content:center}
.ov.show{display:flex}
.mod{background:#fff;width:100%;max-width:480px;border-radius:26px 26px 0 0;
  padding:26px 18px;max-height:88vh;overflow-y:auto;
  animation:su .3s cubic-bezier(.34,1.56,.64,1)}
@keyframes su{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modhd{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.modhd h2{font-size:21px;font-weight:900;color:var(--dk)}
.xbtn{background:var(--g5);border:none;width:32px;height:32px;border-radius:50%;
  font-size:16px;cursor:pointer;color:var(--g2);font-weight:900;display:grid;place-items:center;transition:all .2s}
.xbtn:hover{background:var(--g4);transform:rotate(90deg)}

/* JOIN CODE */
.codebadge{background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#fff;
  border-radius:13px;padding:14px;text-align:center;margin-top:12px}
.codeval{font-size:26px;font-weight:900;letter-spacing:5px;font-family:monospace;margin:6px 0}

/* CHAT */
.chatbox{background:var(--g5);border-radius:13px;padding:11px;
  max-height:270px;overflow-y:auto;margin-bottom:11px;scroll-behavior:smooth}
.cmsg{background:#fff;border-radius:11px;padding:9px 11px;margin-bottom:7px;
  box-shadow:0 1px 4px rgba(5,150,105,.07)}
.cmsg.me{background:var(--g4)}.cmsg.bot{background:linear-gradient(135deg,#d1fae5,#a7f3d0)}
.cwho{font-size:11px;font-weight:800;color:var(--g2);margin-bottom:2px}
.ctxt{font-size:13px;color:var(--dk);white-space:pre-wrap;line-height:1.5}
.ctm{font-size:10px;color:var(--sf);margin-top:2px}
.chatsend{display:flex;gap:8px}
.chatinp{flex:1;padding:11px 13px;border:2px solid var(--g4);border-radius:11px;
  font-size:13px;font-family:'Nunito',sans-serif}
.chatinp:focus{outline:none;border-color:var(--g3)}
.chatbtn{background:linear-gradient(135deg,var(--g2),var(--g3));color:#fff;border:none;
  padding:11px 16px;border-radius:11px;font-weight:800;cursor:pointer;font-size:13px;
  font-family:'Nunito',sans-serif}

/* DEBT */
.debtcard{border-left:4px solid var(--rd);background:#fef2f2;border-radius:11px;padding:14px;margin-bottom:11px}
.debtcard.paid{border-left-color:var(--g3);background:var(--g5)}
.debtwarn{background:#fee2e2;border:1.5px solid var(--rd);color:#991b1b;
  border-radius:8px;padding:9px 11px;font-size:12px;font-weight:700;margin-top:7px}

/* SCHEMES */
.scheme{background:linear-gradient(135deg,#dbeafe,#bfdbfe);border:2px solid var(--bl);
  border-radius:15px;padding:15px;margin-bottom:12px}
.scheme h4{font-size:14px;font-weight:900;color:#1e40af;margin-bottom:5px}
.scheme p{font-size:12px;color:#1e3a8a;line-height:1.5;margin-bottom:4px}
.scheme a{color:var(--bl);font-weight:800;font-size:12px}

/* INFO */
.info{background:#dbeafe;border:1.5px solid var(--bl);color:#1e40af;
  border-radius:9px;padding:11px;font-size:12px;line-height:1.5;margin:9px 0}

/* EMPTY */
.empty{text-align:center;padding:36px 16px;color:var(--sf)}
.empty .ei{font-size:48px;opacity:.45;margin-bottom:10px}
.empty p{font-size:14px}

/* PROFILE ROWS */
.prow{display:flex;justify-content:space-between;padding:9px 0;
  border-bottom:1.5px solid var(--g5);font-size:13px}
.prow:last-child{border-bottom:none}
.pk{color:var(--g2);font-weight:700}.pv{font-weight:800;color:var(--dk)}
</style>
</head>
<body>
<div id="root"></div>
<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   CONSTANTS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const USER_KEY = 'ss_user';
const DATA_KEY = 'ss_data';

const STATES = [
  'Andhra Pradesh','Arunachal Pradesh','Assam','Bihar','Chhattisgarh','Goa','Gujarat',
  'Haryana','Himachal Pradesh','Jharkhand','Karnataka','Kerala','Madhya Pradesh',
  'Maharashtra','Manipur','Meghalaya','Mizoram','Nagaland','Odisha','Punjab',
  'Rajasthan','Sikkim','Tamil Nadu','Telangana','Tripura','Uttar Pradesh',
  'Uttarakhand','West Bengal',
  'â”€â”€ Union Territories â”€â”€',
  'Andaman & Nicobar Islands','Chandigarh','Dadra & Nagar Haveli & Daman & Diu',
  'Delhi (NCT)','Jammu & Kashmir','Ladakh','Lakshadweep','Puducherry'
];

const JOBS = [
  'â”€â”€ Daily & Manual â”€â”€',
  'Daily Wage Labour','Construction Worker / Mason','Painter / Plasterer',
  'Plumber','Electrician','Carpenter','Welder','Blacksmith',
  'â”€â”€ Farming â”€â”€',
  'Farmer / Agriculture','Fisherman','Dairy / Animal Husbandry','Plantation Worker',
  'â”€â”€ Gig & Delivery â”€â”€',
  'Swiggy / Zomato Delivery Rider','Blinkit / Zepto Delivery Rider',
  'Amazon / Flipkart Delivery','Porter / Dunzo Runner',
  'Ola / Uber Cab Driver','Rapido Bike Taxi','Auto Rickshaw Driver',
  'Truck / Lorry Driver','Bus / Tempo Driver',
  'â”€â”€ Trade & Vendor â”€â”€',
  'Street Vendor / Hawker','Fruit & Vegetable Seller','Tea / Chai Stall',
  'Small Shop Owner','Mechanic (Bike/Car)',
  'â”€â”€ Services â”€â”€',
  'Domestic Worker / Maid','Cook / Household Help','Security Guard',
  'Sanitation / Sweeper','Laundry / Dhobi','Barber / Beautician',
  'â”€â”€ Factory â”€â”€',
  'Factory / Mill Worker','Textile / Garment Worker','Packaging Worker',
  'â”€â”€ Freelance / Semi-Skilled â”€â”€',
  'Freelancer (IT / Design / Writing)','Tutor / Home Teacher',
  'Tailor / Seamstress','Photographer','Other'
];

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   HELPERS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2, 6); }
function jcode() { return Math.random().toString(36).slice(2, 8).toUpperCase(); }
function ts() {
  return new Date().toLocaleString('en-IN', {
    day:'2-digit', month:'short', year:'numeric',
    hour:'2-digit', minute:'2-digit', hour12:true
  });
}
function tfmt(ms) {
  return new Date(ms).toLocaleTimeString('en-IN', { hour:'2-digit', minute:'2-digit', hour12:true });
}
function todayStr() { return new Date().toISOString().split('T')[0]; }
function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   STORAGE  (user and data stored SEPARATELY)
   Sign-out clears only the user key so data
   remains if same person logs back in.
   Full reset clears the data key.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function loadUser()  { try { return JSON.parse(localStorage.getItem(USER_KEY)) || null; } catch(e) { return null; } }
function saveUser(u) { localStorage.setItem(USER_KEY, JSON.stringify(u)); }
function clearUser() { localStorage.removeItem(USER_KEY); }

function loadData()  {
  try { return JSON.parse(localStorage.getItem(DATA_KEY)) || {}; }
  catch(e) { return {}; }
}
function saveData(d) { localStorage.setItem(DATA_KEY, JSON.stringify(d)); }
function clearData() { localStorage.removeItem(DATA_KEY); }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   APP
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const App = {

  /* â”€â”€ state â”€â”€ */
  user: null,
  transactions: [],
  balance: 0,
  totalIncome: 0,
  totalExpense: 0,
  totalSavings: 0,
  piggyBanks: [],
  chitFunds: [],
  debts: [],
  communityGroups: [],
  groupChats: {},      // id -> [{id,who,text,ts}]
  botChats: [],        // [{role,text,ts}]
  govSchemes: [],

  /* ui */
  view: 'home',
  modal: null,
  mdata: null,
  openGrp: null,

  /* â”€â”€ boot â”€â”€ */
  init() {
    this.user = loadUser();
    const d = loadData();
    this.transactions   = d.transactions   || [];
    this.balance        = d.balance        || 0;
    this.totalIncome    = d.totalIncome    || 0;
    this.totalExpense   = d.totalExpense   || 0;
    this.totalSavings   = d.totalSavings   || 0;
    this.piggyBanks     = d.piggyBanks     || [];
    this.chitFunds      = d.chitFunds      || [];
    this.debts          = d.debts          || [];
    this.communityGroups= d.communityGroups|| [];
    this.groupChats     = d.groupChats     || {};
    this.botChats       = d.botChats       || [];
    this.govSchemes     = d.govSchemes     || [];
    this.render();
  },

  save() {
    saveData({
      transactions: this.transactions,
      balance: this.balance,
      totalIncome: this.totalIncome,
      totalExpense: this.totalExpense,
      totalSavings: this.totalSavings,
      piggyBanks: this.piggyBanks,
      chitFunds: this.chitFunds,
      debts: this.debts,
      communityGroups: this.communityGroups,
      groupChats: this.groupChats,
      botChats: this.botChats,
      govSchemes: this.govSchemes,
    });
  },

  /* â”€â”€ auth â”€â”€ */
  register(name,phone,email,occ,age,income,state) {
    this.user = { name, phone, email, occupation:occ, age:+age, monthlyIncome:+income, state, joined:ts() };
    saveUser(this.user);
    this.govSchemes = this._schemes_for(this.user);
    // create auto-save piggy on first registration
    if (!this.piggyBanks.find(p => p.isAuto)) {
      this.piggyBanks.push({ id: uid(), name:'10% Auto-Save ğŸ¦', target:10000, collected:0, isAuto:true });
    }
    this.save();
    this.view = 'home';
    this.render();
  },

  signOut() {
    if (!confirm('Sign out of SaveSure? Your data will be saved.')) return;
    clearUser();
    this.user = null;
    this.render();         // re-render â†’ shows welcome screen
  },

  resetData() {
    if (!confirm('Delete ALL financial data? Your account stays. This cannot be undone.')) return;
    this.transactions=[]; this.balance=0; this.totalIncome=0; this.totalExpense=0;
    this.totalSavings=0; this.piggyBanks=[]; this.chitFunds=[]; this.debts=[];
    this.communityGroups=[]; this.groupChats={}; this.botChats=[];
    this.save();
    this.view='home';
    this.render();
  },

  /* â”€â”€ transactions â”€â”€ */
  addTx(type, amount, category, desc) {
    const amt = parseFloat(amount);
    if (!amt || amt <= 0) return alert('Please enter a valid amount.');
    const t = { id:uid(), type, amount:amt, category, desc:desc||'', dt:ts() };
    this.transactions.unshift(t);
    if (type === 'income') {
      this.totalIncome += amt;
      this.balance += amt;
      // auto 10% â†’ auto piggy
      const auto = this.piggyBanks.find(p => p.isAuto);
      if (auto) {
        const ten = +(amt * 0.1).toFixed(2);
        auto.collected += ten;
        // also record the auto-transfer so user sees it
        this.transactions.unshift({
          id: uid(), type:'transfer', amount:ten,
          category:'Auto-Save', desc:`10% â†’ ${auto.name}`, dt:ts()
        });
      }
    } else if (type === 'expense') {
      this.totalExpense += amt; this.balance -= amt;
    } else if (type === 'savings') {
      this.totalSavings += amt; this.balance -= amt;
    }
    this.save(); this.closeModal(); this.render();
  },

  deleteTx(id) {
    if (!confirm('Delete this transaction?')) return;
    const t = this.transactions.find(x => x.id === id);
    if (!t) return;
    if (t.type==='income')   { this.totalIncome -= t.amount; this.balance -= t.amount; }
    if (t.type==='expense')  { this.totalExpense -= t.amount; this.balance += t.amount; }
    if (t.type==='savings')  { this.totalSavings -= t.amount; this.balance += t.amount; }
    this.transactions = this.transactions.filter(x => x.id !== id);
    this.save(); this.render();
  },

  /* â”€â”€ piggy banks â”€â”€ */
  createPiggy(name, target) {
    if (!name.trim()) return alert('Enter a name.');
    this.piggyBanks.push({ id:uid(), name:name.trim(), target:+target, collected:0, isAuto:false });
    this.save(); this.closeModal(); this.render();
  },

  addToPiggy(id, amount) {
    const amt = parseFloat(amount);
    if (!amt || amt <= 0) return alert('Enter a valid amount.');
    if (this.balance < amt) return alert('Insufficient balance!');
    const p = this.piggyBanks.find(x => x.id === id);
    if (!p) return;
    p.collected += amt; this.balance -= amt;
    this.transactions.unshift({ id:uid(), type:'transfer', amount:amt, category:'Piggy Bank', desc:`â†’ ${p.name}`, dt:ts() });
    this.save(); this.closeModal(); this.render();
    if (p.collected >= p.target) setTimeout(() => alert(`ğŸ‰ Goal reached: ${p.name}!`), 100);
  },

  deletePiggy(id) {
    if (!confirm('Delete piggy bank? Saved amount returns to balance.')) return;
    const p = this.piggyBanks.find(x => x.id === id);
    if (p) this.balance += p.collected;
    this.piggyBanks = this.piggyBanks.filter(x => x.id !== id);
    this.save(); this.render();
  },

  /* â”€â”€ chit funds â”€â”€ */
  createChitFund(name, monthly, members, duration) {
    const f = {
      id:uid(), name, monthlyAmount:+monthly, members:+members,
      duration:+duration, collected:0, joinCode:jcode(), createdBy:this.user.name
    };
    this.groupChats[f.id] = [];
    this.chitFunds.push(f);
    this.save(); this.closeModal(); this.render();
  },

  joinChitFund(code) {
    const f = this.chitFunds.find(x => x.joinCode === code.toUpperCase().trim());
    if (!f) { alert('âŒ Invalid code. Ask the admin.'); return; }
    alert(`âœ… You joined "${f.name}"!`);
    this.closeModal(); this.render();
  },

  payChitFund(id) {
    const f = this.chitFunds.find(x => x.id === id);
    if (!f) return;
    if (this.balance < f.monthlyAmount) { alert('âŒ Insufficient balance!'); return; }
    if (!confirm(`Pay â‚¹${f.monthlyAmount.toFixed(2)} to "${f.name}"?`)) return;
    this.balance -= f.monthlyAmount;
    f.collected  += f.monthlyAmount;
    this.transactions.unshift({ id:uid(), type:'transfer', amount:f.monthlyAmount, category:'Chit Fund', desc:`â†’ ${f.name}`, dt:ts() });
    this.save(); this.render();
    alert('âœ… Payment successful!');
  },

  deleteChitFund(id) {
    if (!confirm('Delete this chit fund?')) return;
    this.chitFunds = this.chitFunds.filter(x => x.id !== id);
    delete this.groupChats[id];
    this.save(); this.render();
  },

  /* â”€â”€ community groups â”€â”€ */
  createGroup(name, target, members) {
    const g = {
      id:uid(), name, target:+target, members:+members,
      collected:0, joinCode:jcode(), createdBy:this.user.name
    };
    this.groupChats[g.id] = [];
    this.communityGroups.push(g);
    this.save(); this.closeModal(); this.render();
  },

  joinGroupByCode(code) {
    const g = this.communityGroups.find(x => x.joinCode === code.toUpperCase().trim());
    if (!g) { alert('âŒ Invalid code. Ask the admin.'); return; }
    alert(`âœ… You joined "${g.name}"!`);
    this.closeModal(); this.render();
  },

  deleteGroup(id) {
    if (!confirm('Delete this group?')) return;
    this.communityGroups = this.communityGroups.filter(x => x.id !== id);
    delete this.groupChats[id];
    this.save(); this.render();
  },

  /* â”€â”€ group chat â”€â”€ */
  sendGroupMsg(gid, text) {
    if (!text.trim()) return;
    if (!this.groupChats[gid]) this.groupChats[gid] = [];
    this.groupChats[gid].push({ id:uid(), who:this.user.name, text:text.trim(), ts: Date.now() });
    this.save(); this.render();
    setTimeout(() => { const el = document.getElementById('gcb-'+gid); if(el) el.scrollTop=el.scrollHeight; }, 80);
  },

  /* â”€â”€ debts â”€â”€ */
  addDebt(name, principal, rate, dueDate) {
    const p=+principal, r=+rate;
    const days = Math.max(0, Math.ceil((new Date(dueDate)-new Date())/864e5));
    const interest = +(p*r*days/36500).toFixed(2);
    const total    = +(p+interest).toFixed(2);
    this.debts.push({ id:uid(), name, principal:p, rate:r, interest, total, dueDate, paid:false });
    this.save(); this.closeModal(); this.render();
  },

  togglePaid(id) {
    const d = this.debts.find(x => x.id === id);
    if (d) { d.paid = !d.paid; this.save(); this.render(); }
  },

  deleteDebt(id) {
    if (!confirm('Delete this debt record?')) return;
    this.debts = this.debts.filter(x => x.id !== id);
    this.save(); this.render();
  },

  _debtWarn(d) {
    if (d.paid) return '';
    const days = Math.ceil((new Date(d.dueDate)-new Date())/864e5);
    if (days < 0)  return `âš ï¸ OVERDUE by ${-days} day(s)! Total: â‚¹${d.total.toFixed(2)}`;
    if (days <= 7) return `ğŸ”´ DUE IN ${days} day(s). Total: â‚¹${d.total.toFixed(2)}`;
    if (days <= 30)return `ğŸŸ¡ Due in ${days} days. Total: â‚¹${d.total.toFixed(2)}`;
    return '';
  },

  /* â”€â”€ AI chatbot â”€â”€ */
  sendBot(text) {
    if (!text.trim()) return;
    this.botChats.push({ role:'user', text:text.trim(), ts:Date.now() });
    const lo = text.toLowerCase();
    let reply = '';
    if (/scheme|gov|benefit|welfare/.test(lo)) {
      reply = this.govSchemes.length
        ? `ğŸ›ï¸ You have ${this.govSchemes.length} eligible schemes:\n\n`
          + this.govSchemes.map((s,i) => `${i+1}. ${s.name}\n   ${s.description}\n   Benefits: ${s.benefits}`).join('\n\n')
        : 'Update your profile to see schemes.';
    } else if (/balance|money|how much/.test(lo)) {
      reply = `ğŸ’° Balance: â‚¹${this.balance.toFixed(2)}\nğŸ“ˆ Income: â‚¹${this.totalIncome.toFixed(2)}\nğŸ“‰ Expense: â‚¹${this.totalExpense.toFixed(2)}\nğŸ· Savings: â‚¹${this.totalSavings.toFixed(2)}`;
    } else if (/sav/.test(lo)) {
      const r = this.totalIncome>0 ? ((this.totalIncome-this.totalExpense)/this.totalIncome*100).toFixed(1) : 0;
      reply = `ğŸ· Savings rate: ${r}%.\n\nâœ… Tips:\nâ€¢ Aim for 20%+ savings\nâ€¢ Use Piggy Banks for goals\nâ€¢ 10% is auto-saved from every income\nâ€¢ Join chit funds to save together`;
    } else if (/debt|loan/.test(lo)) {
      const act = this.debts.filter(d=>!d.paid);
      reply = `ğŸ›¡ï¸ Active debts: ${act.length}\nTotal due: â‚¹${act.reduce((s,d)=>s+d.total,0).toFixed(2)}\n\nğŸ’¡ Pay high-interest debts first!`;
    } else if (/chit/.test(lo)) {
      reply = `ğŸ¯ Chit funds: ${this.chitFunds.length}\nPay monthly to keep up. Check the Community tab.`;
    } else if (/help|hi|hello|start/.test(lo)) {
      reply = `ğŸ‘‹ I can help you!\n\nTry asking:\nâ€¢ "show my balance"\nâ€¢ "savings tips"\nâ€¢ "government schemes"\nâ€¢ "debt info"\nâ€¢ "chit fund info"`;
    } else {
      reply = `ğŸ¤– Try: "balance", "save", "scheme", "debt" or "help".`;
    }
    this.botChats.push({ role:'bot', text:reply, ts:Date.now() });
    this.save(); this.render();
    setTimeout(() => { const el=document.getElementById('botbox'); if(el) el.scrollTop=el.scrollHeight; }, 80);
  },

  /* â”€â”€ gov schemes â”€â”€ */
  _schemes_for(u) {
    const s=[], occ=(u.occupation||'').toLowerCase(), inc=u.monthlyIncome, age=u.age;

    /* ---- FARMERS ---- */
    if(/farm|agri|dairy|plant/.test(occ)) {
      s.push({name:'PM-KISAN',description:'Pradhan Mantri Kisan Samman Nidhi â€” income support to all farmers owning cultivable land.',benefits:'â‚¹6,000 per year (â‚¹2,000 Ã— 3 installments) directly to bank account',link:'https://pmkisan.gov.in/'});
      s.push({name:'PM Kisan Maan-Dhan (PM-KMY)',description:'Voluntary pension scheme exclusively for small & marginal farmers.',benefits:'â‚¹3,000/month guaranteed pension after age 60',link:'https://pmkmy.gov.in/'});
      s.push({name:'PM Fasal Bima Yojana (PMFBY)',description:'Crop insurance against natural calamities, pests & disease.',benefits:'Full insured sum on crop loss; premium as low as 1.5%',link:'https://pmfby.gov.in/'});
    }

    /* ---- HOUSING (low income) ---- */
    if(inc<25000)
      s.push({name:'PMAY â€” Pradhan Mantri Awas Yojana',description:'Affordable housing for all â€” urban and rural. Subsidy on home loan interest.',benefits:'Interest subsidy up to â‚¹2.67 lakh on home loans',link:'https://pmaymis.gov.in/'});

    /* ---- RURAL / MANUAL LABOUR ---- */
    if(/labour|worker|wage|maid|vendor|sanit|security|fisher|laund|mason|plumb|carp|weld|factor/.test(occ))
      s.push({name:'MGNREGA',description:'Mahatma Gandhi National Rural Employment Guarantee Act â€” legal right to work.',benefits:'100 days guaranteed paid work/year; wages paid within 15 days',link:'https://nrega.nic.in/'});

    /* ---- UNORGANISED / GIG WORKERS ---- */
    if(/delivery|rider|cab|auto|taxi|driver|freelanc|barber|photo|tailor|labour|wage|maid|vendor|domestic|security|fisher|laund|mason|plumb|truck|lorry|street|factory|weaver/.test(occ)) {
      s.push({name:'e-Shram Card',description:'National Database of Unorganised Workers â€” free registration gives access to all labour welfare schemes.',benefits:'â‚¹2 lakh accident insurance FREE; priority access to all welfare benefits',link:'https://eshram.gov.in/'});
      s.push({name:'PM Shram Yogi Maan-Dhan (PM-SYM)',description:'Pension scheme for unorganised/gig workers earning < â‚¹15,000/month.',benefits:'â‚¹3,000/month guaranteed pension after age 60; govt contributes equal amount',link:'https://labour.gov.in/pm-sym'});
    }

    /* ---- HEALTH (lowâ€“mid income) ---- */
    if(inc<40000)
      s.push({name:'Ayushman Bharat â€” PM-JAY',description:'World\'s largest free health insurance for poor & vulnerable families.',benefits:'FREE hospitalisation up to â‚¹5 lakh/year at 25,000+ empanelled hospitals',link:'https://pmjay.gov.in/'});

    /* ---- UNIVERSAL ---- */
    s.push({name:'PM Jan Dhan Yojana (PMJDY)',description:'Zero-balance savings account with debit card and accident insurance.',benefits:'Free bank account + RuPay card + â‚¹2 lakh accident cover + â‚¹10,000 overdraft',link:'https://www.pmjdy.gov.in/'});

    /* ---- PENSION / INSURANCE by age ---- */
    if(age>=18&&age<=40)
      s.push({name:'Atal Pension Yojana (APY)',description:'Guaranteed pension scheme for workers in the unorganised sector.',benefits:'â‚¹1,000 to â‚¹5,000/month guaranteed pension at age 60; govt co-contributes',link:'https://www.npscra.nsdl.co.in/scheme-details.php'});
    if(age>=18&&age<=70)
      s.push({name:'PMSBY â€” Accident Insurance',description:'Pradhan Mantri Suraksha Bima Yojana â€” accidental death & disability cover.',benefits:'â‚¹2 lakh accident cover for just â‚¹20/year (auto-debit from bank)',link:'https://www.jansuraksha.gov.in/PMSBY.aspx'});
    if(age>=18&&age<=50)
      s.push({name:'PMJJBY â€” Life Insurance',description:'Pradhan Mantri Jeevan Jyoti Bima Yojana â€” life cover at minimal premium.',benefits:'â‚¹2 lakh life insurance for just â‚¹436/year (auto-debit from bank)',link:'https://www.jansuraksha.gov.in/PMJJBY.aspx'});

    /* ---- CONSTRUCTION WORKERS ---- */
    if(/construct|labour|mason|plumb|carp|weld|factor/.test(occ))
      s.push({name:'BOCW â€” Construction Worker Welfare',description:'State welfare board benefits for building & other construction workers.',benefits:'Education grant, maternity benefit, pension, medical aid, accident relief',link:'https://labour.gov.in/boc'});

    /* ---- SMALL BUSINESS / SELF-EMPLOYED ---- */
    if(/business|vendor|street|tailor|weaver|barber|beautici|shop|trader/.test(occ))
      s.push({name:'PM MUDRA Yojana',description:'Collateral-free micro loans for small & micro businesses.',benefits:'Loans â‚¹50,000 to â‚¹10 lakh â€” Shishu / Kishore / Tarun tiers',link:'https://www.mudra.org.in/'});

    /* ---- SKILL / TRAINING ---- */
    s.push({name:'PM Kaushal Vikas Yojana (PMKVY)',description:'Free skill development and certification training programs.',benefits:'Free certified skill training + â‚¹8,000 reward + placement support',link:'https://www.pmkvyofficial.org/'});

    return s;
  },

  /* â”€â”€ navigation / modal â”€â”€ */
  go(v)             { this.view=v; this.openGrp=null; this.render(); },
  openModal(m,data) { this.modal=m; this.mdata=data||null; this.render(); },
  closeModal()      { this.modal=null; this.mdata=null; this.render(); },
  showGroup(id)     { this.openGrp=id; this.render(); },

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     RENDER
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  render() {
    const root = document.getElementById('root');
    if (!this.user)              { root.innerHTML = this._vWelcome();  return; }
    if (this.user === 'reg')     { root.innerHTML = this._vReg();      return; }
    root.innerHTML =
      this._vHeader() +
      (this.openGrp ? this._vGroup() : this._vPage()) +
      this._vBnav() +
      this._vModals();
    // auto-scroll chats
    setTimeout(() => {
      const b = document.getElementById('botbox');
      if (b) b.scrollTop = b.scrollHeight;
      if (this.openGrp) {
        const g = document.getElementById('gcb-'+this.openGrp);
        if (g) g.scrollTop = g.scrollHeight;
      }
    }, 60);
  },

  /* â”€â”€ WELCOME â”€â”€ */
  _vWelcome() {
    return `<div class="welcome">
      <div class="wlogo">ğŸŒ±</div>
      <h1 class="wtitle">SaveSure</h1>
      <p class="wsub">Smart Green Savings for Every Worker</p>
      <div class="wfeats">
        <div class="wfeat"><span>ğŸ’°</span>Track Money</div>
        <div class="wfeat"><span>ğŸ·</span>Auto-Save 10%</div>
        <div class="wfeat"><span>ğŸ‘¥</span>Save Together</div>
        <div class="wfeat"><span>ğŸ›ï¸</span>Gov Schemes</div>
        <div class="wfeat"><span>ğŸ¯</span>Chit Funds</div>
        <div class="wfeat"><span>ğŸ¤–</span>AI Advice</div>
      </div>
      <button class="wbtn" onclick="App.user='reg'; App.render()">Get Started â†’</button>
    </div>`;
  },

  /* â”€â”€ REGISTER â”€â”€ */
  _vReg() {
    const stOpts = STATES.map(s =>
      s.startsWith('â”€')
        ? `<option disabled>${s}</option>`
        : `<option value="${esc(s)}">${esc(s)}</option>`
    ).join('');
    const jobOpts = JOBS.map(j =>
      j.startsWith('â”€')
        ? `<option disabled>${j}</option>`
        : `<option value="${esc(j)}">${esc(j)}</option>`
    ).join('');
    return `<div class="regwrap">
      <div class="reghead">
        <div style="font-size:52px;text-align:center;margin-bottom:10px">ğŸŒ±</div>
        <h2>Create Your Account</h2>
        <p>We'll personalise your schemes & experience</p>
      </div>
      <form id="rf" style="max-width:420px;margin:0 auto"
        onsubmit="event.preventDefault();
          const f=document.getElementById('rf');
          App.register(f.n.value,f.ph.value,f.em.value,f.oc.value,f.ag.value,f.ic.value,f.st.value)">
        <div class="fg"><label>Full Name *</label>
          <input name="n" class="inp" placeholder="Your full name" required></div>
        <div class="fg"><label>Phone Number *</label>
          <input name="ph" class="inp" type="tel" placeholder="10-digit mobile" required></div>
        <div class="fg"><label>Email (optional)</label>
          <input name="em" class="inp" type="email" placeholder="email@example.com"></div>
        <div class="fg"><label>Occupation *</label>
          <select name="oc" class="sel" required>
            <option value="">Select your occupation</option>${jobOpts}
          </select></div>
        <div class="fg"><label>Age *</label>
          <input name="ag" class="inp" type="number" min="18" max="100" placeholder="Your age" required></div>
        <div class="fg"><label>Monthly Income (â‚¹) *</label>
          <input name="ic" class="inp" type="number" placeholder="e.g. 12000" required></div>
        <div class="fg"><label>State / UT *</label>
          <select name="st" class="sel" required>
            <option value="">Select your state</option>${stOpts}
          </select></div>
        <div class="info">ğŸ’¡ We use this to find government schemes you qualify for!</div>
        <button type="submit" class="btn btn-g" style="margin-top:6px">Continue to SaveSure â†’</button>
      </form>
    </div>`;
  },

  /* â”€â”€ HEADER â”€â”€ */
  _vHeader() {
    return `<div class="hdr">
      <div>
        <h1>ğŸŒ± SaveSure</h1>
        <div class="hsub">Hi, ${esc(this.user.name)} ğŸ‘‹</div>
      </div>
      <div class="hicns">
        <button class="hic" title="Schemes"   onclick="App.go('schemes')">ğŸ›ï¸</button>
        <button class="hic" title="AI Chat"   onclick="App.openModal('bot')">ğŸ¤–</button>
        <button class="hic" title="Profile"   onclick="App.go('profile')">âš™ï¸</button>
      </div>
    </div>`;
  },

  /* â”€â”€ PAGE ROUTER â”€â”€ */
  _vPage() {
    switch(this.view) {
      case 'home':      return this._vHome();
      case 'history':   return this._vHistory();
      case 'community': return this._vCommunity();
      case 'debt':      return this._vDebt();
      case 'schemes':   return this._vSchemes();
      case 'profile':   return this._vProfile();
      default:          return this._vHome();
    }
  },

  /* â”€â”€ HOME â”€â”€ */
  _vHome() {
    const auto = this.piggyBanks.find(p=>p.isAuto) || {collected:0};
    const pigs = this.piggyBanks.map(p=>this._pigHTML(p)).join('');
    const txs  = this.transactions.slice(0,6);
    return `<div class="page show">
      <div class="balcard">
        <div style="font-size:12px;text-transform:uppercase;letter-spacing:1.5px;opacity:.85">Total Balance</div>
        <div class="balamt">â‚¹${this.balance.toFixed(2)}</div>
        <div class="balrow">
          <div class="balst"><div class="l">Income</div><div class="v">â‚¹${this.totalIncome.toFixed(0)}</div></div>
          <div class="balst"><div class="l">Expense</div><div class="v">â‚¹${this.totalExpense.toFixed(0)}</div></div>
          <div class="balst"><div class="l">Auto-Saved</div><div class="v">â‚¹${auto.collected.toFixed(0)}</div></div>
        </div>
      </div>
      <div class="qarow">
        <div class="qabtn qainc" onclick="App.openModal('income')"><div class="qi">ğŸ’µ</div><div class="ql">Add Income</div></div>
        <div class="qabtn qaexp" onclick="App.openModal('expense')"><div class="qi">ğŸ’¸</div><div class="ql">Add Expense</div></div>
        <div class="qabtn qasav" onclick="App.openModal('savings')"><div class="qi">ğŸ·</div><div class="ql">Add Savings</div></div>
        <div class="qabtn qanew" onclick="App.openModal('newPiggy')"><div class="qi">ğŸ¯</div><div class="ql">New Goal</div></div>
      </div>
      <div style="padding:0 14px">
        ${this.piggyBanks.length > 0 ? `<div class="stitle">ğŸ· Piggy Banks</div><div class="piggrid">${pigs}</div>` : ''}
        <div class="stitle">Recent Transactions</div>
        <div class="card">
          ${txs.length === 0
            ? `<div class="empty"><div class="ei">ğŸ“</div><p>No transactions yet. Add income to start!</p></div>`
            : txs.map(t=>this._txRow(t)).join('')}
        </div>
      </div>
    </div>`;
  },

  _pigHTML(p) {
    const pct = p.target > 0 ? Math.min(100,(p.collected/p.target*100)) : 0;
    return `<div class="pigcard" onclick="App.openModal('addToPiggy','${p.id}')">
      <button class="pig-x" onclick="event.stopPropagation();App.deletePiggy('${p.id}')">Ã—</button>
      <div class="pig-ico">${p.isAuto?'ğŸ¦':'ğŸ·'}</div>
      <div class="pig-nm">${esc(p.name)}</div>
      <div class="pig-am">â‚¹${p.collected.toFixed(0)}<span style="font-size:10px"> / â‚¹${p.target.toFixed(0)}</span></div>
      <div class="pig-pc">${pct.toFixed(0)}% complete</div>
      <div class="pig-bar"><div class="pig-fill" style="width:${pct}%"></div></div>
    </div>`;
  },

  _txRow(t) {
    const ico = {income:'ğŸ’µ',expense:'ğŸ’¸',savings:'ğŸ·',transfer:'ğŸ”„'}[t.type]||'ğŸ’±';
    const sign = t.type==='income' ? '+' : '-';
    const canDel = t.type !== 'transfer';
    return `<div class="txitem">
      <div class="txic ${t.type}">${ico}</div>
      <div class="txbd">
        <div class="txcat">${esc(t.category)}</div>
        ${t.desc ? `<div class="txdsc">${esc(t.desc)}</div>` : ''}
        <div class="txdt">ğŸ“… ${t.dt}</div>
      </div>
      <div class="txrt">
        <div class="txam ${t.type}">${sign}â‚¹${t.amount.toFixed(2)}</div>
        ${canDel ? `<button class="delbtn" onclick="event.stopPropagation();App.deleteTx('${t.id}')">Delete</button>` : ''}
      </div>
    </div>`;
  },

  /* â”€â”€ HISTORY â”€â”€ */
  _vHistory() {
    return `<div class="page show">
      <div class="stitle">ğŸ“Š All Transactions</div>
      <div class="card">
        ${this.transactions.length === 0
          ? `<div class="empty"><div class="ei">ğŸ“Š</div><p>No transactions</p></div>`
          : this.transactions.map(t=>this._txRow(t)).join('')}
      </div>
    </div>`;
  },

  /* â”€â”€ COMMUNITY â”€â”€ */
  _vCommunity() {
    const chitCards = this.chitFunds.length === 0
      ? `<div class="empty" style="padding:20px"><div class="ei" style="font-size:36px">ğŸ¯</div><p>No chit funds yet</p></div>`
      : this.chitFunds.map(f=>`
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:start;gap:10px">
            <div style="flex:1;min-width:0">
              <div style="font-size:16px;font-weight:900;margin-bottom:8px">${esc(f.name)}</div>
              <div style="font-size:12px;color:var(--g2);line-height:1.9">
                Monthly: <b>â‚¹${f.monthlyAmount.toFixed(2)}</b><br>
                Collected: <b style="color:var(--g3)">â‚¹${f.collected.toFixed(2)}</b><br>
                Members: <b>${f.members}</b> Â· Duration: <b>${f.duration} months</b>
              </div>
              <div class="codebadge"><div style="font-size:10px;opacity:.85">Share Join Code</div>
                <div class="codeval">${f.joinCode}</div></div>
            </div>
            <div style="display:flex;flex-direction:column;gap:7px;flex-shrink:0">
              <button class="btsm btsm-g" onclick="App.payChitFund('${f.id}')">ğŸ’³ Pay â‚¹${f.monthlyAmount.toFixed(0)}</button>
              <button class="btsm btsm-s" onclick="App.showGroup('${f.id}')">ğŸ’¬ Chat</button>
              <button class="btsm btsm-r" onclick="App.deleteChitFund('${f.id}')">ğŸ—‘ Delete</button>
            </div>
          </div>
        </div>`).join('');

    const grpCards = this.communityGroups.length === 0
      ? `<div class="empty" style="padding:20px"><div class="ei" style="font-size:36px">ğŸ‘¥</div><p>No groups yet</p></div>`
      : this.communityGroups.map(g=>`
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:start;gap:10px">
            <div style="flex:1;min-width:0">
              <div style="font-size:16px;font-weight:900;margin-bottom:8px">${esc(g.name)}</div>
              <div style="font-size:12px;color:var(--g2);line-height:1.9">
                Target: <b>â‚¹${g.target.toFixed(0)}</b> Â· Members: <b>${g.members}</b>
              </div>
              <div class="codebadge"><div style="font-size:10px;opacity:.85">Share Join Code</div>
                <div class="codeval">${g.joinCode}</div></div>
            </div>
            <div style="display:flex;flex-direction:column;gap:7px;flex-shrink:0">
              <button class="btsm btsm-s" onclick="App.showGroup('${g.id}')">ğŸ’¬ Chat</button>
              <button class="btsm btsm-r" onclick="App.deleteGroup('${g.id}')">ğŸ—‘ Delete</button>
            </div>
          </div>
        </div>`).join('');

    return `<div class="page show">
      <div class="stitle">ğŸ¯ Chit Funds</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
        <button class="btn btn-g" onclick="App.openModal('newChit')">+ Create Fund</button>
        <button class="btn btn-s" style="margin-top:0" onclick="App.openModal('joinChit')">ğŸ”‘ Join by Code</button>
      </div>
      ${chitCards}
      <div class="stitle" style="margin-top:6px">ğŸ‘¥ Community Groups</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
        <button class="btn btn-g" onclick="App.openModal('newGroup')">+ Create Group</button>
        <button class="btn btn-s" style="margin-top:0" onclick="App.openModal('joinGroup')">ğŸ”‘ Join by Code</button>
      </div>
      ${grpCards}
    </div>`;
  },

  /* â”€â”€ GROUP CHAT â”€â”€ */
  _vGroup() {
    const entity = this.chitFunds.find(x=>x.id===this.openGrp)
                || this.communityGroups.find(x=>x.id===this.openGrp);
    if (!entity) { this.openGrp=null; return this._vCommunity(); }
    const msgs = this.groupChats[entity.id] || [];
    const msgsHTML = msgs.length === 0
      ? `<div style="text-align:center;padding:20px;color:var(--sf);font-size:13px">No messages yet. Say hi! ğŸ‘‹</div>`
      : msgs.map(m=>`<div class="cmsg ${m.who===this.user.name?'me':''}">
          <div class="cwho">${esc(m.who)}</div>
          <div class="ctxt">${esc(m.text)}</div>
          <div class="ctm">${tfmt(m.ts)}</div>
        </div>`).join('');
    return `<div class="page show">
      <button class="btn btn-s" style="margin-bottom:12px" onclick="App.openGrp=null;App.go('community')">â† Back</button>
      <div class="stitle">${esc(entity.name)}</div>
      <div class="codebadge" style="margin-bottom:12px">
        <div style="font-size:10px;opacity:.85">Invite members with this code</div>
        <div class="codeval">${entity.joinCode}</div>
      </div>
      <div class="chatbox" id="gcb-${entity.id}">${msgsHTML}</div>
      <div class="chatsend">
        <input class="chatinp" id="gci-${entity.id}" placeholder="Type a messageâ€¦"
          onkeypress="if(event.key==='Enter'){App.sendGroupMsg('${entity.id}',this.value);this.value=''}">
        <button class="chatbtn" onclick="const i=document.getElementById('gci-${entity.id}');App.sendGroupMsg('${entity.id}',i.value);i.value=''">Send</button>
      </div>
    </div>`;
  },

  /* â”€â”€ DEBT â”€â”€ */
  _vDebt() {
    const act = this.debts.filter(d=>!d.paid);
    const totalDue = act.reduce((s,d)=>s+d.total,0);
    return `<div class="page show">
      <div class="stitle">ğŸ›¡ï¸ Debt Shield</div>
      ${act.length > 0 ? `<div class="card" style="background:linear-gradient(135deg,#fef2f2,#fee2e2);border-color:var(--rd);margin-bottom:12px">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div><div style="font-size:10px;color:#991b1b;text-transform:uppercase;font-weight:800">Active Debts</div>
            <div style="font-size:30px;font-weight:900;color:var(--rd)">${act.length}</div></div>
          <div><div style="font-size:10px;color:#991b1b;text-transform:uppercase;font-weight:800">Total Due</div>
            <div style="font-size:30px;font-weight:900;color:var(--rd)">â‚¹${totalDue.toFixed(0)}</div></div>
        </div></div>` : ''}
      <button class="btn btn-g" style="margin-bottom:12px" onclick="App.openModal('newDebt')">+ Add Debt</button>
      ${this.debts.length===0
        ? `<div class="empty"><div class="ei">ğŸ›¡ï¸</div><p>No debts tracked. Great!</p></div>`
        : this.debts.map(d=>`
          <div class="debtcard ${d.paid?'paid':''}">
            <div style="display:flex;justify-content:space-between;align-items:start;gap:10px">
              <div style="flex:1">
                <div style="font-size:15px;font-weight:900;margin-bottom:6px">${esc(d.name)}</div>
                <div style="font-size:12px;color:#6b7280;line-height:2">
                  Principal: â‚¹${d.principal.toFixed(2)}<br>
                  Interest (${d.rate}% p.a.): <span style="color:var(--rd)">â‚¹${d.interest.toFixed(2)}</span><br>
                  <b style="font-size:13px">Total Due: â‚¹${d.total.toFixed(2)}</b><br>
                  Due Date: ${new Date(d.dueDate).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'})}
                </div>
                ${this._debtWarn(d) ? `<div class="debtwarn">${this._debtWarn(d)}</div>` : ''}
              </div>
              <div style="display:flex;flex-direction:column;gap:7px;flex-shrink:0">
                <button class="btsm ${d.paid?'btsm-s':'btsm-g'}" onclick="App.togglePaid('${d.id}')">
                  ${d.paid?'âœ… Paid':'Mark Paid'}
                </button>
                <button class="btsm btsm-r" onclick="App.deleteDebt('${d.id}')">ğŸ—‘ Delete</button>
              </div>
            </div>
          </div>`).join('')}
    </div>`;
  },

  /* â”€â”€ SCHEMES â”€â”€ */
  _vSchemes() {
    return `<div class="page show">
      <div class="stitle">ğŸ›ï¸ Your Gov Schemes</div>
      <div class="info" style="margin-bottom:14px">
        ğŸ¯ Found <b>${this.govSchemes.length} schemes</b> for you based on:<br>
        <b>${esc(this.user.occupation)}</b> Â· Age <b>${this.user.age}</b> Â· â‚¹<b>${this.user.monthlyIncome.toLocaleString()}</b>/month Â· <b>${esc(this.user.state)}</b>
      </div>
      ${this.govSchemes.length === 0
        ? `<div class="empty"><div class="ei">ğŸ›ï¸</div><p>No schemes found. Update your profile.</p></div>`
        : this.govSchemes.map((s,i)=>`
          <div class="scheme">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
              <div style="background:rgba(59,130,246,0.15);color:#1e40af;width:28px;height:28px;border-radius:50%;display:grid;place-items:center;font-size:12px;font-weight:900;flex-shrink:0">${i+1}</div>
              <h4 style="margin:0">${esc(s.name)}</h4>
            </div>
            <p style="margin-bottom:8px">${esc(s.description)}</p>
            <div style="background:white;border-radius:10px;padding:10px 12px;margin-bottom:10px">
              <div style="font-size:11px;text-transform:uppercase;letter-spacing:.8px;color:#3b82f6;font-weight:700;margin-bottom:4px">âœ… Benefits</div>
              <div style="font-size:13px;color:#1e3a8a;font-weight:600">${esc(s.benefits)}</div>
            </div>
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
              <div style="font-size:11px;color:#6b7280;word-break:break-all">${s.link}</div>
              <a href="${s.link}" target="_blank" rel="noopener"
                style="background:linear-gradient(135deg,#2563eb,#3b82f6);color:white;padding:9px 16px;border-radius:10px;font-weight:700;font-size:13px;text-decoration:none;white-space:nowrap;flex-shrink:0">
                Apply Now â†’
              </a>
            </div>
          </div>`).join('')}
      <div class="info" style="margin-top:4px">
        ğŸ’¡ All links open the <b>official government website</b>. You can also visit <a href="https://services.india.gov.in/" target="_blank" style="color:#1e40af;font-weight:700">services.india.gov.in</a> for a complete list.
      </div>
    </div>`;
  },

  /* â”€â”€ PROFILE â”€â”€ */
  _vProfile() {
    return `<div class="page show">
      <div class="stitle">âš™ï¸ Profile</div>
      <div class="card">
        <div class="prow"><span class="pk">Name</span><span class="pv">${esc(this.user.name)}</span></div>
        <div class="prow"><span class="pk">Phone</span><span class="pv">${esc(this.user.phone)}</span></div>
        <div class="prow"><span class="pk">Occupation</span><span class="pv">${esc(this.user.occupation)}</span></div>
        <div class="prow"><span class="pk">Age</span><span class="pv">${this.user.age}</span></div>
        <div class="prow"><span class="pk">Monthly Income</span><span class="pv">â‚¹${Number(this.user.monthlyIncome).toLocaleString()}</span></div>
        <div class="prow"><span class="pk">State</span><span class="pv">${esc(this.user.state)}</span></div>
        <div class="prow"><span class="pk">Joined</span><span class="pv">${this.user.joined}</span></div>
      </div>
      <div class="card">
        <div class="prow"><span class="pk">Balance</span><span class="pv">â‚¹${this.balance.toFixed(2)}</span></div>
        <div class="prow"><span class="pk">Transactions</span><span class="pv">${this.transactions.length}</span></div>
        <div class="prow"><span class="pk">Piggy Banks</span><span class="pv">${this.piggyBanks.length}</span></div>
        <div class="prow"><span class="pk">Chit Funds</span><span class="pv">${this.chitFunds.length}</span></div>
        <div class="prow"><span class="pk">Active Debts</span><span class="pv" style="color:var(--rd)">${this.debts.filter(d=>!d.paid).length}</span></div>
        <div class="prow"><span class="pk">Gov Schemes</span><span class="pv" style="color:var(--bl)">${this.govSchemes.length}</span></div>
      </div>
      <button class="btn btn-r" onclick="App.resetData()">ğŸ—‘ï¸ Reset Financial Data</button>
      <button class="btn btn-s" style="background:#fee2e2;color:var(--rd);margin-top:10px" onclick="App.signOut()">ğŸšª Sign Out</button>
    </div>`;
  },

  /* â”€â”€ BOTTOM NAV â”€â”€ */
  _vBnav() {
    const items = [
      {v:'home',i:'ğŸ ',l:'Home'},
      {v:'history',i:'ğŸ“Š',l:'History'},
      {v:'community',i:'ğŸ‘¥',l:'Community'},
      {v:'debt',i:'ğŸ›¡ï¸',l:'Debt'},
    ];
    return `<div class="bnav">${items.map(x=>`
      <div class="nit ${this.view===x.v&&!this.openGrp?'on':''}" onclick="App.openGrp=null;App.go('${x.v}')">
        <div class="ni">${x.i}</div><div class="nl">${x.l}</div>
      </div>`).join('')}</div>`;
  },

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODALS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  _vModals() {
    if (!this.modal) return '';
    const M = this.modal, D = this.mdata;
    const wrap = (title, body) => `
      <div class="ov show" onclick="if(event.target.classList.contains('ov'))App.closeModal()">
        <div class="mod">
          <div class="modhd"><h2>${title}</h2>
            <button class="xbtn" onclick="App.closeModal()">âœ•</button></div>
          ${body}
        </div>
      </div>`;

    /* TX */
    if (M==='income'||M==='expense'||M==='savings') {
      const cats = {
        income: ['Salary','Daily Wage','Freelance','Business Income','Gig/Delivery Earnings','Bonus','Rental Income','Other'],
        expense:['Food & Groceries','Transport / Fuel','Rent','Electricity / Water','Phone / Internet','Healthcare','Education','Clothing','Entertainment','Loan EMI','Other'],
        savings:['Emergency Fund','Festival Savings','Education Fund','Home Goal','Vehicle Goal','Investment','Other']
      }[M].map(c=>`<option value="${c}">${c}</option>`).join('');
      const icon = M==='income'?'ğŸ’µ':M==='expense'?'ğŸ’¸':'ğŸ·';
      const note = M==='income' ? `<div class="info">ğŸ’¡ 10% of this income will be auto-saved to your ğŸ¦ Auto-Save piggy bank!</div>` : '';
      return wrap(`${icon} ${M==='income'?'Add Income':M==='expense'?'Add Expense':'Add Savings'}`,`
        <form onsubmit="event.preventDefault();App.addTx('${M}',this.a.value,this.c.value,this.d.value)">
          <div class="fg"><label>Amount (â‚¹) *</label>
            <input name="a" class="inp" type="number" step="0.01" placeholder="0.00" required autofocus></div>
          <div class="fg"><label>Category *</label>
            <select name="c" class="sel" required><option value="">Select category</option>${cats}</select></div>
          <div class="fg"><label>Description (optional)</label>
            <input name="d" class="inp" placeholder="Add a noteâ€¦"></div>
          ${note}
          <button type="submit" class="btn btn-g" style="margin-top:4px">Save</button>
          <button type="button" class="btn btn-s" onclick="App.closeModal()">Cancel</button>
        </form>`);
    }

    /* NEW PIGGY */
    if (M==='newPiggy') return wrap('ğŸ· New Piggy Bank Goal',`
      <form onsubmit="event.preventDefault();App.createPiggy(this.n.value,this.t.value)">
        <div class="fg"><label>Goal Name *</label>
          <input name="n" class="inp" placeholder="e.g. New Phone, Festival, Emergencyâ€¦" required></div>
        <div class="fg"><label>Target Amount (â‚¹) *</label>
          <input name="t" class="inp" type="number" placeholder="5000" required></div>
        <button type="submit" class="btn btn-g">Create Piggy Bank</button>
        <button type="button" class="btn btn-s" onclick="App.closeModal()">Cancel</button>
      </form>`);

    /* ADD TO PIGGY */
    if (M==='addToPiggy') {
      const p = this.piggyBanks.find(x=>x.id===D);
      if (!p) return '';
      const pct = p.target>0 ? Math.min(100,(p.collected/p.target*100)) : 0;
      return wrap(`ğŸ· ${esc(p.name)}`,`
        <div style="text-align:center;margin-bottom:18px">
          <div style="font-size:54px">${p.isAuto?'ğŸ¦':'ğŸ·'}</div>
          <div style="font-size:15px;font-weight:900;margin:8px 0">â‚¹${p.collected.toFixed(2)} / â‚¹${p.target.toFixed(2)}</div>
          <div style="font-size:12px;color:var(--sf)">Your balance: â‚¹${this.balance.toFixed(2)}</div>
          <div class="pig-bar" style="max-width:220px;margin:10px auto"><div class="pig-fill" style="width:${pct}%"></div></div>
          <div style="font-size:11px;color:#92400e;margin-top:4px">${pct.toFixed(0)}% complete</div>
        </div>
        <form onsubmit="event.preventDefault();App.addToPiggy('${p.id}',this.am.value)">
          <div class="fg"><label>Amount to Add (â‚¹)</label>
            <input name="am" class="inp" type="number" step="0.01" max="${this.balance}" placeholder="Enter amount" required></div>
          <button type="submit" class="btn btn-g">Add Money ğŸ’°</button>
          <button type="button" class="btn btn-s" onclick="App.closeModal()">Cancel</button>
        </form>`);
    }

    /* NEW CHIT FUND */
    if (M==='newChit') return wrap('ğŸ¯ Create Chit Fund',`
      <form onsubmit="event.preventDefault();App.createChitFund(this.n.value,this.m.value,this.mb.value,this.d.value)">
        <div class="fg"><label>Fund Name *</label>
          <input name="n" class="inp" placeholder="e.g. Neighbourhood Fund" required></div>
        <div class="fg"><label>Monthly Amount (â‚¹) *</label>
          <input name="m" class="inp" type="number" placeholder="500" required></div>
        <div class="fg"><label>Number of Members *</label>
          <input name="mb" class="inp" type="number" placeholder="10" required></div>
        <div class="fg"><label>Duration (months) *</label>
          <input name="d" class="inp" type="number" placeholder="12" required></div>
        <div class="info">ğŸ’¡ A unique join code is created automatically. Share it with members to join!</div>
        <button type="submit" class="btn btn-g">Create Fund</button>
        <button type="button" class="btn btn-s" onclick="App.closeModal()">Cancel</button>
      </form>`);

    /* JOIN CHIT FUND */
    if (M==='joinChit') return wrap('ğŸ”‘ Join Chit Fund',`
      <form onsubmit="event.preventDefault();App.joinChitFund(this.c.value)">
        <div class="fg"><label>Enter Join Code</label>
          <input name="c" class="inp" placeholder="6-character code"
            style="text-transform:uppercase;letter-spacing:5px;font-size:20px;font-weight:900;text-align:center" required></div>
        <div class="info">ğŸ’¡ Ask the chit fund admin for their 6-character code.</div>
        <button type="submit" class="btn btn-g">Join Fund</button>
        <button type="button" class="btn btn-s" onclick="App.closeModal()">Cancel</button>
      </form>`);

    /* NEW GROUP */
    if (M==='newGroup') return wrap('ğŸ‘¥ Create Community Group',`
      <form onsubmit="event.preventDefault();App.createGroup(this.n.value,this.t.value,this.m.value)">
        <div class="fg"><label>Group Name *</label>
          <input name="n" class="inp" placeholder="e.g. Festival Savings" required></div>
        <div class="fg"><label>Savings Target (â‚¹) *</label>
          <input name="t" class="inp" type="number" placeholder="50000" required></div>
        <div class="fg"><label>Number of Members *</label>
          <input name="m" class="inp" type="number" placeholder="5" required></div>
        <div class="info">ğŸ’¡ A unique join code is created. Share with your group!</div>
        <button type="submit" class="btn btn-g">Create Group</button>
        <button type="button" class="btn btn-s" onclick="App.closeModal()">Cancel</button>
      </form>`);

    /* JOIN GROUP */
    if (M==='joinGroup') return wrap('ğŸ”‘ Join Community Group',`
      <form onsubmit="event.preventDefault();App.joinGroupByCode(this.c.value)">
        <div class="fg"><label>Enter Join Code</label>
          <input name="c" class="inp" placeholder="6-character code"
            style="text-transform:uppercase;letter-spacing:5px;font-size:20px;font-weight:900;text-align:center" required></div>
        <div class="info">ğŸ’¡ Ask the group admin for their 6-character code.</div>
        <button type="submit" class="btn btn-g">Join Group</button>
        <button type="button" class="btn btn-s" onclick="App.closeModal()">Cancel</button>
      </form>`);

    /* NEW DEBT */
    if (M==='newDebt') return wrap('ğŸ›¡ï¸ Add Debt',`
      <form onsubmit="event.preventDefault();App.addDebt(this.n.value,this.p.value,this.r.value,this.dd.value)">
        <div class="fg"><label>Lender Name *</label>
          <input name="n" class="inp" placeholder="Bank / Person name" required></div>
        <div class="fg"><label>Principal Amount (â‚¹) *</label>
          <input name="p" class="inp" type="number" step="0.01" placeholder="5000" required></div>
        <div class="fg"><label>Interest Rate (% per year) *</label>
          <input name="r" class="inp" type="number" step="0.01" placeholder="12" required></div>
        <div class="fg"><label>Due Date *</label>
          <input name="dd" class="inp" type="date" min="${todayStr()}" required></div>
        <div class="info">ğŸ’¡ Interest is auto-calculated from today to the due date using simple interest.</div>
        <button type="submit" class="btn btn-g">Add Debt</button>
        <button type="button" class="btn btn-s" onclick="App.closeModal()">Cancel</button>
      </form>`);

    /* BOT CHAT */
    if (M==='bot') {
      const msgs = this.botChats;
      const msgsHTML = msgs.length === 0
        ? `<div class="cmsg bot">
            <div class="cwho">ğŸ¤– SaveSure AI</div>
            <div class="ctxt">ğŸ‘‹ Hello ${esc(this.user.name)}! I can help with:\n\nâ€¢ "scheme" â†’ your govt schemes\nâ€¢ "balance" â†’ your finances\nâ€¢ "save" â†’ savings tips\nâ€¢ "debt" â†’ debt overview\nâ€¢ "help" â†’ all options</div>
          </div>`
        : msgs.map(m=>`<div class="cmsg ${m.role==='bot'?'bot':'me'}">
            <div class="cwho">${m.role==='bot'?'ğŸ¤– SaveSure AI':'ğŸ‘¤ You'}</div>
            <div class="ctxt">${esc(m.text)}</div>
            <div class="ctm">${tfmt(m.ts)}</div>
          </div>`).join('');
      return wrap('ğŸ¤– AI Assistant',`
        <div class="chatbox" id="botbox" style="max-height:380px">${msgsHTML}</div>
        <div class="chatsend">
          <input class="chatinp" id="botinp" placeholder="Ask me anythingâ€¦"
            onkeypress="if(event.key==='Enter'){App.sendBot(this.value);this.value=''}">
          <button class="chatbtn" onclick="const i=document.getElementById('botinp');App.sendBot(i.value);i.value=''">Send</button>
        </div>`);
    }

    return '';
  }
};

document.addEventListener('DOMContentLoaded', () => App.init());
</script>
</body>
</html>
